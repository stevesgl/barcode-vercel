<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 90%;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .btn {
            @apply px-6 py-3 rounded-lg font-semibold transition-all duration-200;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75;
        }
        .input-field {
            @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        /* Dedicated camera viewport styling */
        #cameraViewport {
            width: 100%;
            max-width: 640px; /* Max width for video stream */
            margin: 1.5rem auto; /* Added margin for spacing */
            border: 2px solid #a78bfa; /* Purple border for camera */
            border-radius: 0.75rem; /* Rounded corners */
            overflow: hidden;
            background-color: #000; /* Black background for video */
            display: none; /* Hidden by default, shown when camera activates */
        }
        #cameraViewport video {
            width: 100%;
            height: auto;
            display: block;
        }
        /* Markdown styling for the trust report */
        .markdown-body h1 { @apply text-3xl font-bold mb-4; }
        .markdown-body h2 { @apply text-2xl font-semibold mb-3; }
        .markdown-body h3 { @apply text-xl font-semibold mb-2; }
        .markdown-body p { @apply mb-2 leading-relaxed; }
        .markdown-body ul { @apply list-disc pl-5 mb-2; }
        .markdown-body ol { @apply list-decimal pl-5 mb-2; }
        .markdown-body li { @apply mb-1; }
        .markdown-body strong { @apply font-bold; }
        .markdown-body em { @apply italic; }
        .markdown-body hr { @apply border-t border-gray-300 my-6; }
        .markdown-body pre {
            @apply bg-gray-100 p-4 rounded-lg overflow-x-auto text-sm;
            white-space: pre-wrap; /* Ensures long lines wrap */
            word-wrap: break-word;
        }
        .markdown-body code { @apply font-mono bg-gray-200 px-1 py-0.5 rounded text-sm; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Grocery Scanner</h1>

        <!-- Initial Welcome Message -->
        <div id="welcomeMessage" class="text-center text-gray-600 mb-6 p-4 bg-blue-50 rounded-lg">
            <p class="font-semibold mb-2">Welcome to your Grocery Scanner!</p>
            <p>Enter a GTIN/UPC manually or use your camera to scan a barcode.</p>
        </div>

        <div class="mb-6">
            <label for="gtinInput" class="block text-gray-700 text-sm font-semibold mb-2">Enter GTIN/UPC:</label>
            <input type="text" id="gtinInput" class="input-field" placeholder="e.g., 012345678905">
        </div>

        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
            <button id="scanButton" class="btn btn-primary w-full">Scan Barcode (Camera)</button>
            <button id="lookupButton" class="btn btn-secondary w-full">Lookup GTIN</button>
        </div>

        <!-- Dedicated Camera Viewport -->
        <div id="cameraViewport" class="relative"></div>

        <div id="loadingIndicator" class="text-center text-blue-600 font-medium hidden my-4">
            <!-- Specific loading messages will be inserted here -->
        </div>

        <div id="productInfo" class="my-6 p-4 bg-blue-50 rounded-lg border border-blue-200 hidden">
            <h2 class="text-xl font-semibold text-blue-800 mb-2">Product Details</h2>
            <p><strong class="text-gray-700">GTIN:</strong> <span id="displayGtin"></span></p>
            <p><strong class="text-gray-700">Description:</strong> <span id="displayDescription"></span></p>
            <p><strong class="text-gray-700">Ingredients:</strong> <span id="displayIngredients"></span></p>
        </div>

        <div id="trustReport" class="my-6 p-4 bg-green-50 rounded-lg border border-green-200 hidden markdown-body">
            <!-- Trust report markdown will be rendered here -->
        </div>

        <div id="errorMessage" class="my-6 p-4 bg-red-100 rounded-lg border border-red-300 text-red-700 hidden">
            <!-- Error messages will be displayed here -->
        </div>
    </div>

    <script src="https://unpkg.com/quagga-ui@0.1.0/dist/quagga-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- Marked.js for Markdown rendering -->

    <script>
        const gtinInput = document.getElementById('gtinInput');
        const scanButton = document.getElementById('scanButton');
        const lookupButton = document.getElementById('lookupButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const productInfo = document.getElementById('productInfo');
        const displayGtin = document.getElementById('displayGtin');
        const displayDescription = document.getElementById('displayDescription');
        const displayIngredients = document.getElementById('displayIngredients');
        const trustReportDiv = document.getElementById('trustReport');
        const errorMessageDiv = document.getElementById('errorMessage');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const cameraViewport = document.getElementById('cameraViewport'); // New camera viewport element

        // IMPORTANT: Replace with your actual Render/Vercel backend URL
        const BACKEND_API_URL = 'YOUR_RENDER_BACKEND_URL/api/gtin-lookup'; 
        // Example: 'https://your-app-name.onrender.com/api/gtin-lookup'

        // Function to show messages (errors or loading)
        function showMessage(element, message, isError = false) {
            element.textContent = message;
            element.classList.remove('hidden');
            if (isError) {
                element.classList.remove('bg-blue-50', 'text-blue-600');
                element.classList.add('bg-red-100', 'text-red-700');
            } else {
                element.classList.remove('bg-red-100', 'text-red-700');
                element.classList.add('bg-blue-50', 'text-blue-600');
            }
        }

        // Function to hide all info/error sections
        function hideAllSections() {
            welcomeMessage.classList.add('hidden'); // Hide welcome message after first action
            loadingIndicator.classList.add('hidden');
            productInfo.classList.add('hidden');
            trustReportDiv.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            cameraViewport.classList.add('hidden'); // Hide camera viewport
        }

        // Function to enable/disable buttons
        function setButtonsDisabled(disabled) {
            scanButton.disabled = disabled;
            lookupButton.disabled = disabled;
            if (disabled) {
                scanButton.classList.add('opacity-50', 'cursor-not-allowed');
                lookupButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                scanButton.classList.remove('opacity-50', 'cursor-not-allowed');
                lookupButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Function to fetch product data from backend
        async function fetchProductData(gtin) {
            hideAllSections();
            setButtonsDisabled(true); // Disable buttons
            showMessage(loadingIndicator, 'Fetching product data...');

            try {
                const response = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ gtin: gtin })
                });

                const data = await response.json();

                if (response.ok) {
                    loadingIndicator.classList.add('hidden');
                    productInfo.classList.remove('hidden');
                    
                    displayGtin.textContent = data.gtin;
                    displayDescription.textContent = data.description;
                    displayIngredients.textContent = data.ingredients || 'No ingredients listed.';

                    if (data.trust_report_markdown && data.trust_report_markdown !== "N/A") {
                        trustReportDiv.innerHTML = marked.parse(data.trust_report_markdown);
                        trustReportDiv.classList.remove('hidden');
                    } else {
                        trustReportDiv.classList.add('hidden');
                    }

                } else {
                    showMessage(errorMessageDiv, `Error: ${data.message || 'Product not found or an error occurred.'}`, true);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showMessage(errorMessageDiv, `Network error: Could not connect to the server. ${error.message}`, true);
            } finally {
                setButtonsDisabled(false); // Re-enable buttons
            }
        }

        // Event listener for Lookup button
        lookupButton.addEventListener('click', () => {
            const gtin = gtinInput.value.trim();
            if (gtin) {
                fetchProductData(gtin);
            } else {
                hideAllSections(); // Clear previous results/messages
                showMessage(errorMessageDiv, 'Please enter a GTIN/UPC.', true);
            }
        });

        // Event listener for Scan Barcode button (using QuaggaUI)
        scanButton.addEventListener('click', () => {
            hideAllSections();
            setButtonsDisabled(true); // Disable buttons
            showMessage(loadingIndicator, 'Activating camera for scan...');
            cameraViewport.classList.remove('hidden'); // Show camera viewport

            QuaggaUI.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: cameraViewport // Target the new camera viewport
                },
                decoder: {
                    readers: ["ean_reader", "upc_reader"]
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    showMessage(errorMessageDiv, `Camera error: ${err.message || 'Could not start camera.'}`, true);
                    setButtonsDisabled(false); // Re-enable buttons on error
                    cameraViewport.classList.add('hidden'); // Hide camera viewport on error
                    return;
                }
                loadingIndicator.classList.add('hidden'); // Hide loading text once camera is active
                console.log("Initialization finished. Ready to start");
                QuaggaUI.start();
            });

            QuaggaUI.onDetected(function(result) {
                QuaggaUI.stop(); // Stop scanning after first detection
                cameraViewport.classList.add('hidden'); // Hide camera viewport after scan
                setButtonsDisabled(false); // Re-enable buttons
                const gtin = result.codeResult.code;
                gtinInput.value = gtin; // Populate input field
                fetchProductData(gtin); // Fetch data for the scanned GTIN
            });

            // Optional: visual feedback during scanning (uncomment if desired)
            // QuaggaUI.onProcessed(function(result) {
            //     var drawingCtx = QuaggaUI.canvas.ctx.overlay;
            //     var drawingCanvas = QuaggaUI.canvas.dom.overlay;
            //     if (result) {
            //         if (result.boxes) {
            //             drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
            //             result.boxes.filter(function (box) {
            //                 return box !== result.box;
            //             }).forEach(function (box) {
            //                 Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
            //             });
            //         }
            //         if (result.box) {
            //             Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
            //         }
            //         if (result.codeResult && result.codeResult.code) {
            //             Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
            //         }
            //     }
            // });
        });
    </script>
</body>
</html>
