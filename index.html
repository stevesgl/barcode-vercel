<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Grocery Lens</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-2xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Smart Grocery Lens</h1>

    <!-- GTIN Input -->
    <div class="mb-6">
      <input
        id="gtinInput"
        type="text"
        placeholder="Enter a barcode (GTIN)..."
        class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <button
        onclick="submitGTIN()"
        class="mt-3 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
      >
        Analyze Product
      </button>
    </div>

    <!-- Result Section -->
    <div id="resultContainer" class="hidden">
      <div id="resultText" class="mb-4 text-sm text-gray-700"></div>

      <!-- Trust Report Block -->
      <div id="trust-report" class="mt-6 space-y-4"></div>
    </div>
  </div>

  <!-- Script -->
  <script>
    async function submitGTIN() {
      const gtinInput = document.getElementById("gtinInput");
      const resultContainer = document.getElementById("resultContainer");
      const resultText = document.getElementById("resultText");
      const trustReport = document.getElementById("trust-report");
      const gtin = gtinInput.value.trim();

      resultText.innerText = "⏳ Loading…";
      resultContainer.style.display = "block";
      trustReport.innerHTML = "";

      try {
        console.log("Submitting GTIN:", gtin);

        const response = await fetch("https://smart-grocery-backend-jxku.onrender.com/gtin-lookup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ gtin })
        });

        const raw = await response.text();
        console.log("Backend raw response:", raw);

        if (!raw || raw.trim() === "") {
          throw new Error("Empty response from backend.");
        }

        const parsed = JSON.parse(raw);

        // Basic product summary
        resultText.innerHTML = `
          <p><strong>${parsed.description || "Product Description"}</strong></p>
          <p>Brand: ${parsed.brand_name || "Unknown"} (${parsed.brand_owner || "Unknown"})</p>
        `;

        // Trust Report
        if (parsed.trust_report_html) {
          trustReport.innerHTML = parsed.trust_report_html;
        } else {
          trustReport.innerHTML = "<p class='text-sm text-gray-500'>No Trust Report available.</p>";
        }

      } catch (err) {
        console.error("Failed to parse response:", err);
        resultText.innerHTML = "<p class='text-red-500'>❌ Error loading product. Try again.</p>";
        trustReport.innerHTML = "";
      }
    }

    // Toggle for collapsible sections
    function toggleCollapse(el) {
      const content = el.nextElementSibling;
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
      } else {
        content.classList.add('hidden');
      }
    }
  </script>
</body>
</html>
